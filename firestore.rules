rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function getUserRole() {
      return getUserData().role;
    }
    
    function isAdmin() {
      return isAuthenticated() && getUserRole() == 'ADMIN';
    }
    
    function isLineLeader() {
      return isAuthenticated() && getUserRole() == 'LINE_LEADER';
    }
    
    function isAgent() {
      return isAuthenticated() && getUserRole() == 'AGENT';
    }
    
    // An agent with canRecruitSubagents also has "leader" privileges for their network
    function isEffectiveLeader() {
      return isAuthenticated() && (
        getUserRole() == 'LINE_LEADER' || 
        (getUserRole() == 'AGENT' && getUserData().canRecruitSubagents == true)
      );
    }
    
    function isAdminOrLineLeader() {
      return isAuthenticated() && getUserRole() in ['ADMIN', 'LINE_LEADER'];
    }
    
    // Users collection
    match /users/{userId} {
      // Any authenticated user can read their own document
      allow read: if isAuthenticated() && request.auth.uid == userId;
      
      // Admin and Line Leaders can read all users (for agent listing)
      allow read: if isAuthenticated() && (
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['ADMIN', 'LINE_LEADER']
      );
      
      // Effective leaders can read their subagents
      allow read: if isAuthenticated() && 
        resource.data.lineLeaderId == request.auth.uid;
      
      // Users can update their own non-critical fields
      allow update: if isAuthenticated() && 
        request.auth.uid == userId &&
        !request.resource.data.diff(resource.data).affectedKeys()
          .hasAny(['role', 'refCode', 'lineLeaderId']);
      
      // Admin can update any user (for editing/deactivating agents)
      allow update: if isAdmin();
      
      // Line Leaders and effective leaders can update agents in their network
      allow update: if isEffectiveLeader() && 
        resource.data.lineLeaderId == request.auth.uid &&
        !request.resource.data.diff(resource.data).affectedKeys()
          .hasAny(['role', 'refCode', 'lineLeaderId']);
      
      // Create and delete only via Cloud Functions (service account)
      allow create, delete: if false;
    }
    
    // Leads collection
    match /leads/{leadId} {
      // Anyone can create leads (from chat)
      allow create: if true;
      
      // Read access based on role
      allow read: if isAuthenticated() && (
        isAdmin() ||
        // Line leaders can see leads assigned to their network
        (isLineLeader() && resource.data.assignedLineLeaderId == request.auth.uid) ||
        // Effective leaders (agents with canRecruitSubagents) can see their network leads
        (isEffectiveLeader() && resource.data.assignedLineLeaderId == request.auth.uid) ||
        // Agents can see their assigned leads
        (isAgent() && resource.data.assignedAgentId == request.auth.uid)
      );
      
      // Update access for status changes
      allow update: if isAuthenticated() && (
        isAdmin() ||
        (isLineLeader() && resource.data.assignedLineLeaderId == request.auth.uid) ||
        (isEffectiveLeader() && resource.data.assignedLineLeaderId == request.auth.uid) ||
        (isAgent() && resource.data.assignedAgentId == request.auth.uid)
      );
      
      // Delete only by admin
      allow delete: if isAdmin();
    }
    
    // RefCodes collection - lookup table for referral codes
    match /refCodes/{refCode} {
      // Public read for attribution lookup
      allow read: if true;
      // Write only via Cloud Functions
      allow write: if false;
    }
    
    // Referral Links collection - agents can manage their campaign links
    match /referralLinks/{linkId} {
      // Public read (only contains whatsapp override, contact label, message template - no secrets)
      allow read: if true;
      
      // Agents and admins can create links for themselves
      allow create: if isAuthenticated() && 
        (isAdmin() || isAgent() || isLineLeader()) && 
        request.resource.data.agentUid == request.auth.uid;
      
      // Agents can update/delete their own links, admins can update any
      allow update, delete: if isAuthenticated() && 
        (isAdmin() || resource.data.agentUid == request.auth.uid);
    }
    
    // Chat logs (if needed)
    match /chatLogs/{logId} {
      allow create: if true;
      allow read: if isAuthenticated() && isAdmin();
      allow update, delete: if false;
    }
    
    // Settings (admin only)
    match /settings/{settingId} {
      allow read, write: if isAdmin();
    }
    
    // Chat configs (admin only) - for configurable chat questions
    match /chat_configs/{configId} {
      // Only admins can read and write chat configurations
      allow read, write: if isAdmin();
    }
    
    // Landing content - public read, admin write
    match /landing_content/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }
  }
}
