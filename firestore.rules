rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function getUserRole() {
      return getUserData().role;
    }
    
    function isAdmin() {
      return isAuthenticated() && getUserRole() == 'ADMIN';
    }
    
    function isLineLeader() {
      return isAuthenticated() && getUserRole() == 'LINE_LEADER';
    }
    
    function isAgent() {
      return isAuthenticated() && getUserRole() == 'AGENT';
    }
    
    // An agent with canRecruitSubagents also has "leader" privileges for their network
    function isEffectiveLeader() {
      return isAuthenticated() && (
        getUserRole() == 'LINE_LEADER' || 
        (getUserRole() == 'AGENT' && getUserData().canRecruitSubagents == true)
      );
    }
    
    function isAdminOrLineLeader() {
      return isAuthenticated() && getUserRole() in ['ADMIN', 'LINE_LEADER'];
    }
    
    // Users collection
    match /users/{userId} {
      allow read: if isAuthenticated() && request.auth.uid == userId;
      
      allow read: if isAuthenticated() && (
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['ADMIN', 'LINE_LEADER']
      );
      
      allow read: if isAuthenticated() && 
        resource.data.lineLeaderId == request.auth.uid;
      
      allow update: if isAuthenticated() && 
        request.auth.uid == userId &&
        !request.resource.data.diff(resource.data).affectedKeys()
          .hasAny(['role', 'refCode', 'lineLeaderId']);
      
      allow update: if isAdmin();
      
      allow update: if isEffectiveLeader() && 
        resource.data.lineLeaderId == request.auth.uid &&
        !request.resource.data.diff(resource.data).affectedKeys()
          .hasAny(['role', 'refCode', 'lineLeaderId']);
      
      allow create, delete: if false;
    }
    
    // Leads collection
    match /leads/{leadId} {
      // Anyone can create leads (from chat widget)
      allow create: if true;
      
      // Primary read: upline array contains the authenticated user
      allow read: if isAuthenticated() && 
        resource.data.upline != null && 
        request.auth.uid in resource.data.upline;
      
      // Direct assignment: agent can see their own leads
      allow read: if isAuthenticated() && 
        resource.data.assignedAgentId == request.auth.uid;
      
      // Line leader assignment
      allow read: if isAuthenticated() && 
        resource.data.assignedLineLeaderId == request.auth.uid;
      
      // RefCode match: agent can see leads that came through their referral code
      // Uses the refCode field stored directly in the lead, matched against the agent's refCode
      allow read: if isAuthenticated() && 
        resource.data.refCode != null &&
        resource.data.refCode == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.refCode;
      
      // Admin full read access (separate rule to avoid get() failures affecting other rules)
      allow read: if isAdmin();
      
      // Update access for assigned agents
      allow update: if isAuthenticated() && (
        (resource.data.upline != null && request.auth.uid in resource.data.upline) ||
        resource.data.assignedAgentId == request.auth.uid ||
        resource.data.assignedLineLeaderId == request.auth.uid
      );
      
      // Admin full update access
      allow update: if isAdmin();
      
      // Delete only by admin
      allow delete: if isAdmin();
    }
    
    // RefCodes collection - lookup table for referral codes
    match /refCodes/{refCode} {
      allow read: if true;
      allow write: if false;
    }
    
    // Referral Links collection
    match /referralLinks/{linkId} {
      allow read: if true;
      
      allow create: if isAuthenticated() && 
        (isAdmin() || isAgent() || isLineLeader()) && 
        request.resource.data.agentUid == request.auth.uid;
      
      allow update, delete: if isAuthenticated() && 
        (isAdmin() || resource.data.agentUid == request.auth.uid);
    }
    
    // Tutorials collection
    match /tutorials/{tutorialId} {
      allow read: if resource.data.isPublished == true || 
        isAdmin() ||
        (isAuthenticated() && resource.data.ownerType == 'AGENT' && resource.data.ownerUid == request.auth.uid);
      
      allow create: if isAuthenticated() && (
        isAdmin() || 
        (request.resource.data.ownerType == 'AGENT' && request.resource.data.ownerUid == request.auth.uid)
      );
      
      allow update, delete: if isAuthenticated() && (
        isAdmin() || 
        (resource.data.ownerType == 'AGENT' && resource.data.ownerUid == request.auth.uid)
      );
    }
    
    // Chat logs
    match /chat_logs/{logId} {
      allow create: if true;
      allow read: if isAuthenticated() && (
        isAdmin() ||
        isLineLeader() ||
        isAgent()
      );
      allow update, delete: if false;
    }
    
    // Settings (admin only)
    match /settings/{settingId} {
      allow read, write: if isAdmin();
    }
    
    // Chat configs (admin only)
    match /chat_configs/{configId} {
      allow read, write: if isAdmin();
    }
    
    // Landing content - public read, admin write
    match /landing_content/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }
  }
}